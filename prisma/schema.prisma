// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// BetterAuth User model

model User {
  id                  String   @id @default(cuid())
  email               String   @unique
  emailVerified       Boolean  @default(false)
  name                String?
  image               String?
  role                UserRole @default(SEEKER)
  onboardingCompleted Boolean  @default(false)
  onboardingStep      Int      @default(0)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  organization   Organization?
  organizationProfile OrganizationProfile?
  preferences    UserPreferences?
  accounts       Account[]
  sessions       Session[]
  grantMatches   GrantMatch[]
  submissions    Submission[]
  payments       Payment[]
  aiUsage        AIUsage[]
  notifications  Notification[]
  aiSessions     AIGrantSession[]
  uploadedRFPs   GrantRFP[]
  feedback       Feedback[]
  auditLogs      AuditLog[]

  lastLoginAt   DateTime?
  loginAttempts Int?      @default(0)
  lockedUntil   DateTime?

  @@map("user")
}

// BetterAuth Account model

model Account {
  id                    String    @id @default(cuid())
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@map("account")
}

// BetterAuth Session model

model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

// BetterAuth Verification model

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([identifier, value])
  @@map("verification")
}

// Organization model

model Organization {
  id              String             @id @default(cuid())
  userId          String             @unique
  name            String
  website         String?
  orgType         OrganizationType
  orgSize         OrganizationSize
  industries      Industry[]
  country         String
  grantSizeRange  GrantSizeRange?    // Optional grant size range selection
  fundingNeeds    FundingNeed[]      // Optional funding needs
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("organizations")
}

// User preferences model (enhanced for notifications and matching)
model UserPreferences {
  id                    String          @id @default(cuid())
  userId                String          @unique
  categories            GrantCategory[]
  
  // Notification preferences
  emailNotifications    Boolean         @default(true)
  whatsappNotifications Boolean         @default(false)
  inAppNotifications    Boolean         @default(true)
  deadlineReminders     Boolean         @default(true)
  matchNotifications    Boolean         @default(true)
  
  // Matching preferences
  preferredFundingMin   Decimal?
  preferredFundingMax   Decimal?
  preferredRegions      String[]        // Array of regions/countries
  excludedFunders       String[]        // Funders to exclude from matches
  
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

// Enums

enum UserRole {
  SEEKER
  WRITER
  FUNDER
  ADMIN
}

enum OrganizationType {
  BUSINESS
  NONPROFIT
  GOVERNMENT
  SOCIAL_ENTERPRISE
  RESEARCH_ACADEMIC
  OTHER
}

enum OrganizationSize {
  SOLO_1
  MICRO_2_10
  SMALL_11_50
  MEDIUM_51_250
  LARGE_250_PLUS
}

enum GrantSizeRange {
  UNDER_10K
  TEN_TO_50K
  FIFTY_TO_100K
  HUNDRED_TO_500K
  FIVE_HUNDRED_K_TO_1M
  OVER_1M
}

enum UserPosition {
  CEO
  FOUNDER
  PROGRAM_MANAGER
  DEVELOPMENT_MANAGER
  GRANT_WRITER
  OPERATIONS_MANAGER
  PROJECT_COORDINATOR
  RESEARCH_DIRECTOR
  FINANCE_MANAGER
  OTHER
}

enum Industry {
  HEALTHCARE
  PUBLIC_HEALTH
  EDUCATION
  AGRICULTURE
  ENVIRONMENT
  TECHNOLOGY
  CLIMATE
  SUPPLY_CHAIN
  HUMANITARIAN
  GENDER
}

enum FundingNeed {
  CAPACITY_BUILDING
  RESEARCH
  PROJECT_IMPLEMENTATION
  EQUIPMENT
  TRAINING
}

enum GrantCategory {
  HEALTHCARE_PUBLIC_HEALTH
  EDUCATION_TRAINING
  AGRICULTURE_FOOD_SECURITY
  CLIMATE_ENVIRONMENT
  TECHNOLOGY_INNOVATION
  WOMEN_YOUTH_EMPOWERMENT
  ARTS_CULTURE
  COMMUNITY_DEVELOPMENT
  HUMAN_RIGHTS_GOVERNANCE
  SME_BUSINESS_GROWTH
}

// Business Logic Tables

// Enhanced Funders model for comprehensive grant writing support
model Funder {
  id           String      @id @default(cuid())
  name         String
  type         FunderType
  website      String?
  contactEmail String?
  logoUrl      String?     // Funder logo for beautiful grant cards
  
  // Mission & Strategic Information
  mission              String?     // Organization mission statement
  vision               String?     // Vision statement
  values               Json?       // Array of core values
  strategicPriorities  Json?       // Array of current strategic priorities
  focusAreas           Json?       // Array of focus areas/themes
  
  // Funding Patterns & Preferences
  annualBudget         Decimal?    // Total annual giving budget
  typicalGrantMin      Decimal?    // Typical minimum grant size
  typicalGrantMax      Decimal?    // Typical maximum grant size
  averageGrantSize     Decimal?    // Average grant size
  totalGrantsPerYear   Int?        // Number of grants awarded annually
  
  // Geographic & Demographic Preferences
  geographicFocus      Json?       // Array of preferred regions/countries
  populationFocus      Json?       // Target populations (youth, women, etc.)
  organizationTypes    Json?       // Preferred grantee types (NGO, academic, etc.)
  
  // Application & Review Process
  applicationProcess   String?     // Description of application process
  reviewCriteria       Json?       // Array of evaluation criteria
  reviewTimeline       String?     // Typical review timeline
  successRate          Decimal?    // Percentage of applications funded
  competitionLevel     String?     // HIGH, MEDIUM, LOW
  
  // Key Personnel & Contacts
  programOfficers      Json?       // Array of program officer contacts
  boardMembers         Json?       // Array of board member info
  keyDecisionMakers    Json?       // Key people in funding decisions
  
  // Policies & Requirements
  indirectCostPolicy   String?     // Indirect cost policies
  reportingRequirements String?    // Required reporting and milestones
  partnershipRequirements String? // Required partnerships or collaborations
  technicalAssistance Boolean?    @default(false) // Provides TA to grantees
  
  // Historical Data
  pastRecipients       Json?       // Array of past grant recipients
  fundingHistory       Json?       // Historical funding patterns
  
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  // Relations
  grants Grant[]

  @@map("funders")
}

// Enhanced Grants model for comprehensive proposal writing support
model Grant {
  id                  String        @id @default(cuid())
  funderId            String?
  title               String
  description         String?
  eligibilityCriteria String?
  deadline            DateTime?
  fundingAmountMin    Decimal?
  fundingAmountMax    Decimal?
  source              String?
  category            GrantCategory
  scrapedFrom         String?
  
  // Enhanced fields for scraping and AI
  locationEligibility Json?         // Array of country codes/regions
  applicationMethod   String?       // "Online", "Email", "Portal"
  applicationUrl      String?       // Direct application link
  requiredDocuments   Json?         // Array of required documents
  confidenceScore     Decimal?      // Extraction confidence (0-1)
  contentHash         String?       // For change detection in scraping
  language            String?       @default("en")
  aiSummary          String?       // AI-generated summary
  deadlineTimestamp  DateTime?     // For precise notifications
  isFeatured         Boolean       @default(false)
  sector             String?       // Broader categorization
  subCategory        String?       // More granular than category
  applicantType      String?       // SME, NGO, Academic, etc.
  fundingType        FundingType?  // Grant, loan, equity, etc.
  durationMonths     Int?          // Project duration
  contactEmail       String?       // Funder contact
  fundingCycle       String?       // Annual, quarterly, rolling
  regionFocus        String?       // Geographic focus
  rfaPdfUrl          String?       // Link to RFP document
  sourceUpdatedAt    DateTime?     // When source last changed
  status             String?       @default("ACTIVE") // ACTIVE, EXPIRED, CLOSED
  
  // COMPREHENSIVE RFP & PROPOSAL WRITING FIELDS
  
  // Complete Raw Content Storage
  rawContent          String?       // Complete original content (text/PDF content)
  contentSource       String?       // Source type: "text", "pdf", "url", "manual"
  originalFileName    String?       // Original filename if uploaded
  
  // Detailed RFP Information
  rfpNumber           String?       // Official RFP/FOA number
  programAnnouncement String?       // Full program announcement text
  backgroundContext   String?       // Background and context for the grant
  programGoals        Json?         // Array of program goals and objectives
  expectedOutcomes    Json?         // Array of expected outcomes/deliverables
  keyActivities       Json?         // Array of key activities/components
  
  // Evaluation & Scoring
  evaluationCriteria  Json?         // Detailed evaluation criteria with weights
  scoringRubric       Json?         // Scoring rubric and point allocations
  reviewProcess       String?       // Description of review process
  selectionCriteria   String?       // Selection criteria and preferences
  
  // Proposal Requirements
  proposalSections    Json?         // Required proposal sections and descriptions
  pageLimit           Int?          // Maximum page limit
  wordLimit           Int?          // Maximum word limit
  formatRequirements  String?       // Formatting requirements (font, spacing, etc.)
  submissionFormat    String?       // Required submission format (PDF, online, etc.)
  
  // Budget & Financial
  budgetRequirements  Json?         // Budget requirements and restrictions (array or string)
  costShareRequired   Boolean?      @default(false) // Cost sharing required
  costSharePercentage Decimal?      // Required cost share percentage
  indirectCostRate    Decimal?      // Allowed indirect cost rate
  budgetCategories    Json?         // Allowed budget categories
  
  // Collaboration & Partnerships
  partnershipRequired Boolean?      @default(false) // Partnership required
  requiredPartners    Json?         // Array of required partner types
  preferredPartners   Json?         // Array of preferred partners
  collaborationLevel  String?       // Level of collaboration expected
  
  // Reporting & Compliance
  reportingSchedule   Json?         // Required reporting schedule
  performanceMetrics  Json?         // Required performance metrics/KPIs
  complianceRequirements String?    // Compliance and regulatory requirements
  auditRequirements   String?       // Audit and financial oversight requirements
  
  // Historical Success Data
  pastAwardees        Json?         // Array of past award recipients
  successfulProposals Json?         // Examples of successful proposals
  commonMistakes      Json?         // Array of common application mistakes
  tipsForSuccess      Json?         // Array of tips for successful applications
  
  // Technical Assistance & Support
  technicalAssistance Boolean?      @default(false) // TA provided
  informationSessions Json?         // Array of information session details
  contactPersons      Json?         // Array of contact persons for questions
  faqUrl              String?       // Link to FAQ page
  
  // Competition & Context
  expectedApplications Int?         // Expected number of applications
  awardsAvailable     Int?          // Number of awards available
  competitionLevel    String?       // HIGH, MEDIUM, LOW competition
  fundingHistory      Json?         // Historical funding amounts and recipients
  
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  // Relations
  funder         Funder?           @relation(fields: [funderId], references: [id], onDelete: SetNull)
  matches        GrantMatch[]
  submissions    Submission[]
  tags           GrantTag[]
  rfpDocuments   GrantRFP[]
  aiSessions     AIGrantSession[]
  feedback       Feedback[]

  @@map("grants")
}

// Grant matches (recommendations)
model GrantMatch {
  id         String           @id @default(cuid())
  userId     String
  grantId    String
  matchScore Int?             @default(0)
  status     GrantMatchStatus @default(SAVED)
  createdAt  DateTime         @default(now())

  // Relations
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  grant Grant @relation(fields: [grantId], references: [id], onDelete: Cascade)

  @@map("grant_matches")
}

// Submissions (tracking proposals)
model Submission {
  id           String           @id @default(cuid())
  userId       String
  grantId      String
  proposalText String?
  status       SubmissionStatus @default(DRAFT)
  submittedAt  DateTime?
  resultDate   DateTime?
  createdAt    DateTime         @default(now())

  // Relations
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  grant Grant @relation(fields: [grantId], references: [id], onDelete: Cascade)

  @@map("submissions")
}

// Scraped sources (Enhanced for comprehensive scraping)
model ScrapedSource {
  id             String              @id @default(cuid())
  url            String              @unique
  type           ScrapedSourceType
  lastScrapedAt  DateTime?
  frequency      ScrapingFrequency   @default(WEEKLY)
  status         ScrapedSourceStatus @default(ACTIVE)
  
  // Enhanced scraping metadata
  category       String?             // Healthcare, Climate, etc.
  region         String?             // Geographic focus
  notes          String?             // Admin notes
  successRate    Decimal?            // Success percentage
  avgParseTime   Int?                // Average parsing time in ms
  failCount      Int?                @default(0)
  lastError      String?             // Last error message
  
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  // Relations
  scrapeJobs     ScrapeJob[]

  @@map("scraped_sources")
}

// Payments (DodoPayments synced)
model Payment {
  id               String            @id @default(cuid())
  userId           String
  amount           Decimal
  currency         String            @default("USD")
  provider         PaymentProvider
  subscriptionPlan SubscriptionPlan
  status           PaymentStatus     @default(PAID)
  lastPaymentDate  DateTime?
  createdAt        DateTime          @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("payments")
}

// AI usage tracking
model AIUsage {
  id         String     @id @default(cuid())
  userId     String
  taskType   AITaskType
  tokensUsed Int
  costUsd    Decimal
  createdAt  DateTime   @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("ai_usage")
}

// Additional Enums
enum FunderType {
  PRIVATE_FOUNDATION
  GOVERNMENT
  NGO
  CORPORATE
}

enum GrantMatchStatus {
  SAVED
  APPLIED
  REJECTED
}

enum SubmissionStatus {
  DRAFT
  SUBMITTED
  WON
  LOST
}

enum ScrapedSourceType {
  GOV
  FOUNDATION
  BUSINESS
  NGO
  OTHER
}

enum ScrapingFrequency {
  DAILY
  WEEKLY
  MONTHLY
}

enum ScrapedSourceStatus {
  ACTIVE
  INACTIVE
}

enum PaymentProvider {
  POLAR
  DODOPAYMENTS
}

enum SubscriptionPlan {
  BASIC
  PRO
  ENTERPRISE
}

enum PaymentStatus {
  PAID
  FAILED
  REFUNDED
}

enum AITaskType {
  PROPOSAL_GENERATION
  EDITING
  SUMMARIZATION
  GRANT_ANALYSIS
  REQUIREMENT_EXTRACTION
}

enum FundingType {
  GRANT
  LOAN
  EQUITY
  FELLOWSHIP
  AWARD
  SUBSIDY
  PRIZE
}

enum MessageSender {
  USER
  AI
}

enum MessageType {
  TEXT
  FILE
  SUMMARY
  INSTRUCTION
  SYSTEM
}

enum NotificationType {
  DEADLINE_REMINDER
  NEW_GRANT_MATCH
  SUBMISSION_STATUS
  PAYMENT_SUCCESS
  AI_USAGE_ALERT
  SCRAPE_COMPLETED
  SYSTEM_MAINTENANCE
}

enum NotificationChannel {
  IN_APP
  EMAIL
  WHATSAPP
  SMS
}

enum ScrapeJobStatus {
  PENDING
  RUNNING
  SUCCESS
  FAILED
  CANCELLED
}

enum AuditAction {
  LOGIN
  LOGOUT
  GRANT_SAVED
  PROPOSAL_SUBMITTED
  PAYMENT_MADE
  PROFILE_UPDATED
  SCRAPE_EXECUTED
  FILE_UPLOADED
  AI_SESSION_STARTED
  NOTIFICATION_SENT
}

// ============================================================================
// AI AND DOCUMENT MANAGEMENT MODELS
// ============================================================================

// Enhanced Grant RFP Documents with detailed analysis for proposal writing
model GrantRFP {
  id            String   @id @default(cuid())
  grantId       String?
  uploadedById  String?
  title         String?
  sourceUrl     String?
  fileUrl       String?  // S3/Vercel Blob URL
  fileName      String?
  fileSize      Int?     // File size in bytes
  mimeType      String?  // PDF, DOCX, etc.
  extractedText String?  // Parsed content from document
  summary       String?  // AI-generated summary
  vectorReady   Boolean  @default(false) // For future vector search
  processingStatus String? @default("pending") // pending, processing, completed, failed
  
  // ENHANCED RFP ANALYSIS FIELDS
  
  // Document Structure Analysis
  documentSections    Json?    // Extracted sections and their content
  requirementsList    Json?    // Extracted list of all requirements
  evaluationCriteria  Json?    // Extracted evaluation criteria
  budgetGuidelines    Json?    // Extracted budget guidelines
  timelineRequirements Json?   // Extracted timeline and milestone requirements
  
  // AI-Powered Analysis
  keyThemes           Json?    // AI-identified key themes and priorities
  successFactors      Json?    // AI-identified success factors
  riskFactors         Json?    // AI-identified risk factors
  proposalStrategy    String?  // AI-generated proposal strategy recommendations
  competitiveAdvantage String? // AI-suggested competitive advantages to highlight
  
  // Proposal Writing Assistance
  proposalOutline     Json?    // AI-generated proposal outline
  sectionTemplates    Json?    // Templates for each required section
  writingTips         Json?    // Section-specific writing tips
  commonPitfalls      Json?    // Common pitfalls to avoid
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  grant      Grant? @relation(fields: [grantId], references: [id], onDelete: SetNull)
  uploadedBy User?  @relation(fields: [uploadedById], references: [id], onDelete: SetNull)

  @@map("grant_rfp")
}

// New model for storing organization profiles for better grant matching
model OrganizationProfile {
  id                    String   @id @default(cuid())
  userId                String   @unique
  
  // Mission & Vision
  mission               String?  // Organization mission statement
  vision                String?  // Organization vision
  values                Json?    // Array of organizational values
  
  // Organizational Details
  foundedYear           Int?     // Year organization was founded
  legalStatus           String?  // 501c3, LLC, etc.
  taxId                 String?  // Tax ID/EIN number
  registrationNumber    String?  // Registration number if applicable
  
  // Financial Information
  annualBudget          Decimal? // Annual operating budget
  fundingHistory        Json?    // Array of past funding received
  currentFunding        Json?    // Array of current funding sources
  financialHealth       String?  // STRONG, MODERATE, WEAK
  
  // Capacity & Experience
  staffCount            Int?     // Number of staff members
  volunteerCount        Int?     // Number of volunteers
  boardSize             Int?     // Number of board members
  keyPersonnel          Json?    // Array of key personnel and their roles
  pastProjects          Json?    // Array of past projects and outcomes
  
  // Track Record
  grantsReceived        Json?    // Array of grants received with details
  grantsApplied         Json?    // Array of grants applied to (success/failure)
  successRate           Decimal? // Grant application success rate
  totalFundingReceived  Decimal? // Total funding received to date
  
  // Capabilities & Assets
  coreCompetencies      Json?    // Array of core competencies
  technicalCapabilities Json?   // Array of technical capabilities
  partnerships          Json?    // Array of current partnerships
  infrastructure        Json?    // Physical and technical infrastructure
  
  // Impact & Outcomes
  impactMetrics         Json?    // Array of impact metrics and data
  beneficiariesServed   Int?     // Number of beneficiaries served
  geographicReach       Json?    // Array of geographic areas served
  outcomeStories        Json?    // Array of success stories and case studies
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("organization_profiles")
}

// AI Grant Sessions (persistent chat workspaces per grant)
model AIGrantSession {
  id             String    @id @default(cuid())
  userId         String
  grantId        String
  title          String?   // User-defined session title
  contextSummary String?   // AI-maintained context summary
  lastMessageAt  DateTime?
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  grant    Grant           @relation(fields: [grantId], references: [id], onDelete: Cascade)
  messages AIMessage[]
  files    AIContextFile[]

  @@unique([userId, grantId]) // One active session per user per grant
  @@map("ai_grant_sessions")
}

// AI Messages (chat history within sessions)
model AIMessage {
  id          String      @id @default(cuid())
  sessionId   String
  sender      MessageSender
  messageType MessageType
  content     String
  metadata    Json?       // Token usage, model used, confidence, etc.
  parentId    String?     // For threaded conversations
  createdAt   DateTime    @default(now())

  // Relations
  session AIGrantSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  parent  AIMessage?     @relation("MessageThread", fields: [parentId], references: [id])
  replies AIMessage[]    @relation("MessageThread")

  @@map("ai_messages")
}

// AI Context Files (documents uploaded within chat sessions)
model AIContextFile {
  id            String   @id @default(cuid())
  sessionId     String
  fileName      String
  fileUrl       String
  mimeType      String
  sizeBytes     Int
  uploadedBy    String
  extractedText String?  // Parsed content for AI context
  summary       String?  // AI summary of the file
  createdAt     DateTime @default(now())

  // Relations
  session AIGrantSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("ai_context_files")
}

// ============================================================================
// NOTIFICATION AND COMMUNICATION MODELS
// ============================================================================

// Notifications (email, WhatsApp, in-app alerts)
model Notification {
  id        String              @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  link      String?             // Deep link to relevant page
  read      Boolean             @default(false)
  channel   NotificationChannel @default(IN_APP)
  sentAt    DateTime?           // When actually sent
  metadata  Json?               // Additional data (grant_id, etc.)
  createdAt DateTime            @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

// ============================================================================
// ENHANCED CLASSIFICATION AND TAGGING
// ============================================================================

// Grant Tags (multi-tag classification for better matching)
model GrantTag {
  id      String @id @default(cuid())
  grantId String
  tag     String
  source  String? @default("system") // system, user, ai

  // Relations
  grant Grant @relation(fields: [grantId], references: [id], onDelete: Cascade)

  @@unique([grantId, tag])
  @@map("grant_tags")
}

// ============================================================================
// SCRAPING AND DATA PIPELINE MODELS
// ============================================================================

// Scrape Jobs (audit trail and monitoring)
model ScrapeJob {
  id            String          @id @default(cuid())
  sourceId      String
  status        ScrapeJobStatus @default(PENDING)
  totalFound    Int?            // Total grants found
  totalInserted Int?            // New grants added
  totalUpdated  Int?            // Existing grants updated
  totalSkipped  Int?            // Grants skipped (duplicates, etc.)
  startedAt     DateTime        @default(now())
  finishedAt    DateTime?
  duration      Int?            // Duration in seconds
  log           String?         // Detailed log or error messages
  metadata      Json?           // Additional scraping metadata

  // Relations
  source ScrapedSource @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  @@map("scrape_jobs")
}

// ============================================================================
// FEEDBACK AND QUALITY ASSURANCE
// ============================================================================

// User Feedback (for improving matching and grant quality)
model Feedback {
  id          String   @id @default(cuid())
  userId      String
  grantId     String?
  type        String?  // "match_quality", "grant_accuracy", "feature_request"
  message     String
  rating      Int?     // 1-5 rating
  resolved    Boolean  @default(false)
  adminNotes  String?  // Internal notes
  createdAt   DateTime @default(now())

  // Relations
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  grant Grant? @relation(fields: [grantId], references: [id], onDelete: SetNull)

  @@map("feedback")
}

// ============================================================================
// AUDIT AND COMPLIANCE
// ============================================================================

// Audit Log (track important system and user actions)
model AuditLog {
  id         String      @id @default(cuid())
  userId     String?
  action     AuditAction
  entityType String?     // "grant", "user", "payment", etc.
  entityId   String?     // ID of the affected entity
  metadata   Json?       // Additional context data
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime    @default(now())

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("audit_log")
}

// ============================================================================
// ADVANCED MATCHING AND ANALYTICS
// ============================================================================

// Grant Match Analytics (track matching performance)
model MatchAnalytics {
  id            String   @id @default(cuid())
  userId        String
  grantId       String
  matchScore    Decimal  // Computed match score
  factors       Json     // Breakdown of matching factors
  userAction    String?  // "saved", "applied", "dismissed"
  createdAt     DateTime @default(now())

  @@map("match_analytics")
}

// User Activity Tracking (for personalization)
model UserActivity {
  id         String   @id @default(cuid())
  userId     String
  action     String   // "viewed_grant", "searched", "filtered"
  entityType String?  // "grant", "funder"
  entityId   String?
  metadata   Json?    // Search terms, filters used, etc.
  createdAt  DateTime @default(now())

  @@map("user_activity")
}

// ============================================================================
// SYSTEM CONFIGURATION
// ============================================================================

// System Settings (for admin configuration)
model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  type      String   @default("string") // string, number, boolean, json
  category  String?  // grouping settings
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("system_settings")
}